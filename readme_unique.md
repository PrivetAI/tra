# План уникализации видео (без реализации)

Статус: не реализовано. Эта спецификация фиксирует запланированный функционал и интерфейсы для будущей версии. На текущем этапе API возвращает 501 Not Implemented, UI показывает нотификацию и общий блок «Уникализированные видео» как заглушку.

## Цели
- Повышение уникальности коротких видео без существенной потери качества и смысла.
- Минимизация вмешательства в контент, сохранение длительности и синхронизации аудио/видео.

## Пайплайн (черновик)
1) Вход: локальный файл, гарантированно скачанный `yt-dlp`.
2) Нормализация (при необходимости): фиксированный контейнер mp4 (h264/aac), константный fps/битрейт.
3) Операции уникализации (опционально, настраиваемые пресеты):
   - Обрезка кадра (crop) — пресеты 9:16 центр/кастом.
   - Водяной знак (drawtext или логотип, нижний правый угол, безопасные поля).
   - Изменение скорости (видео `setpts`, аудио `atempo`).
   - Незаметные трансформации: легкая шкала яркости/контраста/цвета в границах допустимого.
4) Выход: mp4 (h264/aac), имя файла с суффиксом `-unique`.

Инструменты: `fluent-ffmpeg` (Node) или `ffmpeg` напрямую; для сложных цепочек — CLI с фильтрами.

## API (на будущее)
- POST `/videos/:platform/:videoId/unique`
  - Вход: `{ preset?: "default" | "light" | "custom", options?: { crop?, text?, speed?, filters? } }`
  - Выход (план): `{ jobId }` → отслеживание через `/unique/:jobId`.
- GET `/unique/:jobId`
  - Статус: `queued|processing|ready|error`, прогресс (0–100), ссылка на скачанный уникализированный файл.

На текущем этапе оба эндпоинта являются заглушками и возвращают 501 Not Implemented.

## Модель данных (дополнительно, на будущее)
- Расширить `Video` полями:
  - `unique`: { `status`: enum, `options`: object, `processedPath?`: string, `error?`: string, `createdAt`, `updatedAt` }
- Или отдельная коллекция `UniqueJobs` с ссылкой на `videoId`.

## Очереди и производительность
- Отдельные очереди Bull.js per-платформа для уникализации.
- Ограничить параллелизм (2–3 джоба на хост) из-за нагрузки ffmpeg.
- Кэширование результатов (если опции идентичные) через ключ `{platform}:{videoId}:{optionsHash}`.

## UX
- В таблицах результатов — кнопка «Отправить на уникализацию» (активна, но сейчас приводит к 501 и подсказке).
- Общий блок «Уникализированные видео» (внизу): список работ со статусами, индикатор прогресса, ссылка «Скачать» у готовых.
- Диалоги ошибок с подробностями и рекомендациями.

## Риски
- FFmpeg интенсивно использует CPU/IO; нужен контроль параллелизма.
- Возможные провалы качества при агрессивных настройках — необходимы пресеты и безопасные дефолты.

## Критерии готовности к реализации
- Стабильная загрузка исходных видео и достаточные метаданные в БД.
- Набор интеграционных тестов для пайплайна (моковые короткие клипы, проверка длительности/дорожек/кодеков).
- Выделенные очереди и базовая телеметрия (время обработки, ошибки).

> Примечание: пока уникализация недоступна. Этот документ описывает будущую реализацию, интерфейсы и UX.

